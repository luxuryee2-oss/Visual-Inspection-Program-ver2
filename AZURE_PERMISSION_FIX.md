# 🔐 Azure AD 권한 오류 해결 가이드

## 현재 문제

**오류**: `401 Unauthorized - SharePoint에 접근할 수 있는 권한이 없습니다.`

이는 Azure AD 앱에 필요한 권한이 없거나 관리자 동의가 완료되지 않았음을 의미합니다.

---

## ✅ 해결 단계

### 1단계: 토큰 발급 확인

먼저 토큰이 제대로 발급되는지 확인하세요:

**브라우저에서 접속:**
```
http://localhost:3000/api/inspection/auth-test
```

**결과 확인:**
- ✅ `"success": true` → 토큰 발급 성공 (권한 문제)
- ❌ `"success": false` → 토큰 발급 실패 (인증 정보 문제)

---

### 2단계: Azure Portal에서 권한 확인 및 수정

#### A. Azure Portal 접속
1. https://portal.azure.com 접속
2. Azure Active Directory로 이동
3. 왼쪽 메뉴에서 **"앱 등록"** 클릭

#### B. 앱 선택
- 앱 등록 목록에서 해당 앱을 찾아 클릭
- 앱 이름: `Visual Inspection Program` 또는 설정한 이름

#### C. API 권한 확인

**⚠️ 중요: "위임된 권한"이 아니라 "애플리케이션 권한"이어야 합니다!**

1. 왼쪽 메뉴에서 **"API 권한"** 클릭
2. 현재 권한 목록 확인:

**현재 설정이 다음과 같으면 문제입니다:**
```
❌ 위임된 권한
   - Sites.ReadWrite.All
```

**올바른 설정:**
```
✅ 애플리케이션 권한
   - Sites.ReadWrite.All
```

#### D. 올바른 권한 추가하기

1. **"권한 추가"** 버튼 클릭
2. **"Microsoft Graph"** 선택
3. **"애플리케이션 권한"** 탭 선택 (중요!)
4. 검색창에 `Sites` 입력
5. **`Sites.ReadWrite.All`** 체크박스 선택
6. **"권한 추가"** 버튼 클릭

#### E. 관리자 동의 부여

**⚠️ 반드시 필요한 단계입니다!**

1. 권한 추가 후, 목록에서 `Sites.ReadWrite.All` 확인
2. 오른쪽에 **"관리자 동의 부여"** 버튼이 보이면 클릭
3. 확인 창에서 **"예"** 클릭

**관리자 동의가 완료되면:**
- 상태가 **"부여됨"** 또는 **"Granted"**로 변경됩니다
- 초록색 체크 표시가 나타납니다

---

### 3단계: 클라이언트 시크릿 확인

#### A. 클라이언트 시크릿 확인
1. 앱 등록 페이지에서 **"인증서 및 비밀"** 메뉴 클릭
2. **"클라이언트 비밀"** 탭 확인
3. 만료된 시크릿이 있는지 확인

#### B. 새 클라이언트 시크릿 생성 (필요시)
1. **"+ 새 클라이언트 비밀"** 클릭
2. 설명 입력 (예: "Visual Inspection App Secret")
3. 만료 기간 선택 (24개월 권장)
4. **"추가"** 클릭
5. **⚠️ 즉시 시크릿 값 복사** (다시 볼 수 없음!)
6. `.env` 파일의 `AZURE_CLIENT_SECRET` 업데이트
7. 서버 재시작

---

### 4단계: 권한 적용 확인

권한 변경 후 **5-10분 정도 기다려야** 적용될 수 있습니다.

그 다음 다시 테스트:

1. **인증 테스트**: http://localhost:3000/api/inspection/auth-test
2. **리스트 정보**: http://localhost:3000/api/inspection/list-info

---

## 🔍 체크리스트

다음을 모두 확인하세요:

- [ ] Azure Portal에서 앱 등록 페이지 접속
- [ ] "API 권한" 메뉴에서 `Sites.ReadWrite.All` 확인
- [ ] **"애플리케이션 권한"**으로 설정되어 있는지 확인 (위임된 권한 아님!)
- [ ] **"관리자 동의 부여"** 완료 확인
- [ ] 상태가 **"부여됨"** 또는 **"Granted"**인지 확인
- [ ] 클라이언트 시크릿이 만료되지 않았는지 확인
- [ ] `.env` 파일의 `AZURE_CLIENT_SECRET`이 최신 값인지 확인

---

## 📸 스크린샷 가이드

### 올바른 권한 설정 예시

```
API 권한
├── Microsoft Graph
    └── Sites.ReadWrite.All (애플리케이션 권한) ✅
        └── 상태: 부여됨 ✅
```

### 잘못된 권한 설정 예시

```
API 권한
├── Microsoft Graph
    └── Sites.ReadWrite.All (위임된 권한) ❌
        └── 상태: 부여 안 됨 ❌
```

---

## 🆘 여전히 안 되면?

### 추가 확인사항

1. **테넌트 ID 확인**
   - `.env` 파일의 `AZURE_TENANT_ID`가 올바른지 확인
   - Azure Portal → 앱 등록 → 개요에서 확인

2. **클라이언트 ID 확인**
   - `.env` 파일의 `AZURE_CLIENT_ID`가 올바른지 확인
   - Azure Portal → 앱 등록 → 개요에서 확인

3. **서버 재시작**
   - 권한 변경 후 서버를 재시작하세요
   - 터미널에서 `Ctrl + C`로 중지 후 `npm run dev` 재실행

4. **캐시 클리어**
   - Azure AD 토큰 캐시가 있을 수 있음
   - 서버 재시작으로 해결됨

---

## 📞 지원 필요 시

다음 정보를 수집해서 전산팀에 문의하세요:

1. **오류 메시지**: 브라우저에서 받은 전체 오류 메시지
2. **토큰 테스트 결과**: `http://localhost:3000/api/inspection/auth-test` 결과
3. **Azure Portal 스크린샷**:
   - API 권한 페이지
   - 관리자 동의 상태

---

이 단계를 따라하면 401 오류를 해결할 수 있습니다! 🎉

